<!-- templates/dashboard.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ZOCK Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#050617; color:#e6fbff; font-family: Arial, sans-serif; margin:0; padding:20px; }
    header { display:flex; align-items:center; gap:16px; }
    h1 { color:#00d8ff; margin:0; }
    .top { display:flex; gap:20px; margin-top:16px; }
    .card { background:#0b1220; padding:20px; border-radius:8px; box-shadow:0 6px 14px rgba(0,0,0,0.6); }
    .big { font-size:32px; color:#00ffea; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:12px; border-bottom:1px solid #15202b; text-align:left; color:#dff7ff; }
    th { color:#9ef0ff; background:#15202b; }
    button { background:#0088cc; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-size:14px; }
    button:hover { background:#0077bb; }
    .controls { margin-left:auto; display:flex; gap:10px; }
    .severity-high { color: #ff4444; font-weight:bold; }
    .severity-medium { color: #ffaa00; font-weight:bold; }
    .severity-low { color: #44ff44; font-weight:bold; }
    .severity-critical { color: #ff00ff; font-weight:bold; }
    .status-sent { color: #44ff44; }
    .status-pending { color: #ffaa00; }
    .stats-grid { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:15px; margin-bottom:20px; }
    .stat-card { text-align:center; }
    .siem-badge { background:#0088cc; color:white; padding:4px 8px; border-radius:4px; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üõ° ZOCK AI Threat Detection</h1>
      <div style="color:#9bdfff">Multi-SIEM Integration Platform ‚Äî Real-time Security Monitoring</div>
    </div>
    <div class="controls">
      <button onclick="generateAlerts()">üö® Generate Alerts</button>
      <button onclick="testSIEM()">üîó Test SIEM Integration</button>
      <button onclick="downloadAlerts()">üì• Export Alerts</button>
      <button onclick="clearAlerts()">üóëÔ∏è Clear All</button>
    </div>
  </header>

  <div class="stats-grid">
    <div class="card stat-card">
      <div style="font-size:14px;color:#9bdfff">Total Alerts</div>
      <div id="totalAlerts" class="big">0</div>
    </div>
    <div class="card stat-card">
      <div style="font-size:14px;color:#9bdfff">SIEM Alerts Sent</div>
      <div id="siemAlerts" class="big">0</div>
    </div>
    <div class="card stat-card">
      <div style="font-size:14px;color:#9bdfff">Critical Alerts</div>
      <div id="criticalAlerts" class="big">0</div>
    </div>
    <div class="card stat-card">
      <div style="font-size:14px;color:#9bdfff">High Severity</div>
      <div id="highAlerts" class="big">0</div>
    </div>
  </div>

  <div class="top">
    <div class="card" style="flex:1">
      <h3 style="margin:0 0 15px 0;color:#9bdfff">Threat Distribution</h3>
      <canvas id="threatChart" height="120"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:20px">
    <h3 style="margin:0 0 15px 0;color:#9bdfff">Security Alerts</h3>
    <table id="alertsTable">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Threat Type</th>
          <th>Severity</th>
          <th>Source IP</th>
          <th>OWASP</th>
          <th>SIEM Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
let threatChart = null;

async function fetchAlerts(){
  const r = await fetch('/api/alerts');
  return r.json();
}

async function fetchStats(){
  const r = await fetch('/api/stats');
  return r.json();
}

async function refresh(){
  const alerts = await fetchAlerts();
  const stats = await fetchStats();
  
  // Update statistics
  document.getElementById('totalAlerts').innerText = stats.total_alerts;
  document.getElementById('siemAlerts').innerText = stats.siem_alerts;
  document.getElementById('criticalAlerts').innerText = stats.critical_alerts;
  document.getElementById('highAlerts').innerText = stats.high_alerts;

  // Populate table
  const tbody = document.querySelector("#alertsTable tbody");
  tbody.innerHTML = "";
  
  alerts.slice().reverse().forEach(a => {
    const tr = document.createElement('tr');
    const severityClass = `severity-${a.severity?.toLowerCase() || 'medium'}`;
    const statusClass = a.siem_sent ? 'status-sent' : 'status-pending';
    
    tr.innerHTML = `
      <td>${a.timestamp || ''}</td>
      <td><strong>${a.threat_type || ''}</strong></td>
      <td class="${severityClass}">${a.severity || 'Medium'}</td>
      <td>${a.source_ip || ''}</td>
      <td>${a.owasp_category || 'N/A'}</td>
      <td class="${statusClass}">${a.siem_sent ? '‚úÖ Sent to SIEM' : '‚è≥ Pending'}</td>
    `;
    tbody.appendChild(tr);
  });

  // Update chart
  updateThreatChart(alerts);
}

function updateThreatChart(alerts) {
  const threatCounts = {};
  alerts.forEach(a => { 
    const threat = a.threat_type || 'Unknown';
    threatCounts[threat] = (threatCounts[threat] || 0) + 1; 
  });

  const ctx = document.getElementById('threatChart').getContext('2d');
  
  if (threatChart) {
    threatChart.destroy();
  }

  threatChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(threatCounts),
      datasets: [{
        data: Object.values(threatCounts),
        backgroundColor: [
          '#ff4444', '#ffaa00', '#44ff44', '#ff00ff', 
          '#0088ff', '#aa00ff', '#ff0088'
        ],
        borderColor: '#0b1220',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#bff', font: { size: 12 } }
        }
      }
    }
  });
}

async function generateAlerts(){
  const r = await fetch('/api/generate', { method:'POST' });
  const result = await r.json();
  alert(`‚úÖ ${result.message}`);
  await refresh();
}

async function testSIEM(){
  const r = await fetch('/api/test-siem', { method:'POST' });
  const result = await r.json();
  alert(`üîó ${result.message}\nPlatforms: ${result.siems_joined}`);
  await refresh();
}

async function downloadAlerts(){
  const r = await fetch('/api/alerts');
  const alerts = await r.json();
  const blob = new Blob([JSON.stringify(alerts, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = `zock_alerts_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
}

async function clearAlerts(){
  if(confirm('Are you sure you want to clear all alerts?')) {
    const r = await fetch('/api/clear', { method:'POST' });
    const result = await r.json();
    alert('üóëÔ∏è All alerts cleared');
    await refresh();
  }
}

// Initial load and auto-refresh
refresh();
setInterval(refresh, 5000); // Refresh every 5 seconds
</script>
</body>
</html>